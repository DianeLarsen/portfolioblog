---
title: Update - Haven's Heroes
summary: Building Haven's Heroes - Progress, Challenges, and Lessons Learned
image: /images/projects/hhupdate.webp
author: 'Diane Larsen'
publishedAt: '2025-03-04'
---

---

# **Havenâ€™s Heroes Development Update - March 2025**  
ğŸš€ *Progress, Fixes, and Lessons Learned*  

---

## **ğŸ“Œ Summary**
Over the past few weeks, Iâ€™ve been making significant improvements to **Havenâ€™s Heroes**, including **fixing authentication issues, improving file uploads, refining role-based access, handling dark mode properly, and streamlining database interactions**.  
This update highlights the **major fixes, enhancements, and lessons learned** in building the project.  

---

## **ğŸ” Authentication & User Role Fixes**  

### **1ï¸âƒ£ Clerk Authentication Fixes**  
ğŸ”¹ Issue:  
- `userId` was sometimes `undefined`, causing authentication failures.  
- Users were not being **automatically redirected** to the sign-in page when their session expired.  

ğŸ”¹ Solution:  
- Used **`getAuth(headers())` instead of `auth()`** to properly retrieve the authenticated user.  
- Implemented **instant redirection to `/sign-in`** if `userId` was missing.  
- Added a **loading state** to prevent UI flickers while Clerk was resolving authentication.  

ğŸ”¹ Code Fix:  
```tsx
useEffect(() => {
  if (isLoaded && !userId) {
    console.error("âŒ User not authenticated! Redirecting to sign-in...");
    router.push("/sign-in");
  }
}, [isLoaded, userId, router]);
```  

âœ… *Outcome:* **Seamless authentication handling with auto-redirects** when needed.  

---  

### **2ï¸âƒ£ Role-Based Access Control (RBAC) for Admins**  
ğŸ”¹ Issue:  
- Needed a way to **restrict admin-only pages** while keeping the user role data efficient.  
- **Prismaâ€™s check constraints** caused issues when adding a `role` column to the `User` model.  

ğŸ”¹ Solution:  
- **Added a `role` field** to the `User` table with values `"Admin"` and `"Member"`, defaulting to `"Member"`.  
- Implemented role-based **access restrictions on `/admin`**:
  - Non-admin users are **redirected to the homepage** instead of seeing an error.  
  - Used `select: { role: true }` in Prisma to fetch only the necessary field for efficiency.  

ğŸ”¹ Code Fix (Prisma Model Update):  
```prisma
model User {
  id          String   @id @default(uuid())
  username    String   @unique
  role        String   @default("Member") // Admin or Member
}
```  

ğŸ”¹ Code Fix (Server Role Check):  
```tsx
import { getUserRole } from "@/lib/actions";
import Admin from "@/components/Admin";

const AdminPage = async () => {
  const role = await getUserRole(); // âœ… Fetch role on the server

  return <Admin role={role} />;
};

export default AdminPage;
```  

âœ… *Outcome:* **Admin-only pages are now properly restricted** and load efficiently.  

---

## **ğŸ“† Birthday Tracking Enhancements**  

### **3ï¸âƒ£ Improved Upcoming Birthdays Display**  
ğŸ”¹ Issue:  
- **Birthdays Component (`Birthdays.tsx`)** was fetching unnecessary data, causing performance issues.  
- Users **without a birthday** were still being included in the list.  

ğŸ”¹ Solution:  
- **Filtered users without a birthday** so they donâ€™t appear in the upcoming birthdays list.  
- Added a **â€œMembers Missing Birthdaysâ€** section (only visible to admins).  
- Clicking a userâ€™s name **now navigates to their profile page**.  

ğŸ”¹ Code Fix (Fetching Upcoming Birthdays):  
```tsx
const upcomingBirthdays = await getUpcomingBirthdays(limit);
const usersMissingBirthdays = isAdmin ? await getUsersMissingBirthdays() : [];
```  

âœ… *Outcome:*  
- **Only users with birthdays are shown.**  
- **Admins can track users missing birthdays.**  
- **Improved UI performance by reducing unnecessary fetch requests.**  

---

## **ğŸ–¼ Cloudinary File Upload Fixes**  

### **4ï¸âƒ£ Instant Cover Image Updates**
ğŸ”¹ Issue:  
- `CldUploadWidget` was causing **TypeScript errors** due to mismatched types.  
- Cover image **wasnâ€™t updating instantly** after upload.  

ğŸ”¹ Solution:  
- **Checked if `result.info` was an object before accessing `secure_url`**.  
- Updated the **cover image preview instantly** after upload.  
- **Displayed a warning message**: "Cover image updated! Changes will not be saved until you press 'Update'."  

ğŸ”¹ Code Fix:  
```tsx
<CldUploadWidget
  uploadPreset="havens_heroes"
  onSuccess={(result) => {
    if (typeof result.info === "object" && result.info !== null && "secure_url" in result.info) {
      setCover(result.info.secure_url as string);
      setShowWarning(true);
    }
  }}
>
```  

âœ… *Outcome:* **Cover image updates instantly, and users get a warning if changes aren't saved.**  

---

## **ğŸŒ™ Dark Mode Enhancements**  

### **5ï¸âƒ£ Fixed Dark Mode UI Issues**  
ğŸ”¹ Issue:  
- The **modal background remained white** even in dark mode.  

ğŸ”¹ Solution:  
- Explicitly set **dark mode styles** using Tailwindâ€™s `dark:` classes.  
- Verified **`ThemeProvider`** was properly configured.  

ğŸ”¹ Code Fix:  
```tsx
<ThemeProvider attribute="class" defaultTheme="system" enableSystem>
```  

```tsx
<form className="bg-white dark:bg-gray-900 dark:text-white p-12 rounded-lg shadow-md">
```  

âœ… *Outcome:* **UI elements now properly reflect system dark mode settings.**  

---

## **ğŸ”§ Middleware & Database Optimizations**  

### **6ï¸âƒ£ Improved Middleware Database Handling**  
ğŸ”¹ Issue:  
- **Database checks were being called multiple times**, causing unnecessary fetch requests.  
- Intermittent **Supabase connection failures** led to inconsistent app behavior.  

ğŸ”¹ Solution:  
- Added a **global variable (`dbConnected`)** to track database connection status.  
- Prevented redundant checks by **storing the status in middleware**.  
- Redirected users to a **maintenance page** if the database was down.  

ğŸ”¹ Code Fix (Middleware Update):  
```tsx
declare global {
  var dbConnected: boolean | undefined;
}
globalThis.dbConnected = globalThis.dbConnected ?? false;

export default clerkMiddleware(async (auth, req: NextRequest) => {
  if (globalThis.dbConnected) {
    console.log("âœ… Database already verified");
    return NextResponse.next();
  }

  try {
    const res = await fetch(`${req.nextUrl.origin}/api/check-db`, {
      method: "GET",
      cache: "no-store",
    });

    if (!res.ok) {
      return NextResponse.redirect(new URL("/maintenance", req.url));
    }
    
    globalThis.dbConnected = true;
  } catch (error) {
    console.error("âŒ Database check failed:", error);
    return NextResponse.redirect(new URL("/maintenance", req.url));
  }

  return NextResponse.next();
});
```  

âœ… *Outcome:*  
- **Database connections are checked only once per request cycle.**  
- **Reduced unnecessary API calls and improved performance.**  

---

## **ğŸš€ Final Outcome & Next Steps**  

âœ… **Fixed authentication issues (auto-redirect on session expiration).**  
âœ… **Admin role-based access now works properly.**  
âœ… **Birthday tracking is more efficient and only shows valid users.**  
âœ… **Dark mode styling is now fully functional.**  
âœ… **Cover image uploads instantly, with a warning message.**  
âœ… **Middleware now prevents excessive database checks.**  

---

## **ğŸ”œ Whatâ€™s Next?**  
- **Test Brevo email sending** once the account is activated.  
- **Refine admin panel UI** for better user management.  
- **Further optimize database queries** to ensure scalability.  

ğŸš€ **The platform is shaping up well! Looking forward to the next set of improvements.** ğŸ‰  

---

